<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test GoiTap Create</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; border: none; border-radius: 3px; }
        .btn-success { background-color: #28a745; color: white; border: none; border-radius: 3px; }
        .btn-danger { background-color: #dc3545; color: white; border: none; border-radius: 3px; }
        #results { margin-top: 20px; }
        .result-item { margin: 10px 0; padding: 10px; border-radius: 3px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test GoiTap Create Functionality</h1>
    
    <div class="test-section info">
        <h3>üìã Test Configuration</h3>
        <p><strong>Base URL:</strong> <span id="baseUrl">http://localhost:5003</span></p>
        <p><strong>Test Data:</strong></p>
        <ul>
            <li>T√™n g√≥i: "G√≥i Test Premium"</li>
            <li>Th·ªùi h·∫°n: 3 th√°ng</li>
            <li>S·ªë bu·ªïi t·ªëi ƒëa: 50</li>
            <li>Gi√°: 1500000 VNƒê</li>
            <li>M√¥ t·∫£: "G√≥i test ƒë·ªÉ ki·ªÉm tra ch·ª©c nƒÉng t·∫°o g√≥i t·∫≠p"</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>üîê Step 1: Login as Admin</h3>
        <button class="btn-primary" onclick="testLogin()">Test Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h3>üìÑ Step 2: Get Create Form</h3>
        <button class="btn-primary" onclick="testGetCreateForm()">Get Create Form</button>
        <div id="createFormResult"></div>
    </div>

    <div class="test-section">
        <h3>‚úÖ Step 3: Submit Create Form</h3>
        <button class="btn-success" onclick="testSubmitCreateForm()">Submit Create Form</button>
        <div id="submitResult"></div>
    </div>

    <div class="test-section">
        <h3>üìä Step 4: Verify Creation</h3>
        <button class="btn-primary" onclick="testVerifyCreation()">Verify Creation</button>
        <div id="verifyResult"></div>
    </div>

    <div class="test-section">
        <h3>üßπ Cleanup</h3>
        <button class="btn-danger" onclick="cleanup()">Delete Test Data</button>
        <div id="cleanupResult"></div>
    </div>

    <div id="results">
        <h3>üìù Test Results</h3>
        <div id="testResults"></div>
    </div>

    <script>
        const baseUrl = 'http://localhost:5003';
        let authToken = '';
        let sessionCookies = '';
        let testGoiTapId = null;

        // Test data
        const testData = {
            TenGoi: 'G√≥i Test Premium',
            ThoiHanThang: 3,
            SoBuoiToiDa: 50,
            Gia: 1500000,
            MoTa: 'G√≥i test ƒë·ªÉ ki·ªÉm tra ch·ª©c nƒÉng t·∫°o g√≥i t·∫≠p',
            LoaiGoi: 'PREMIUM',
            TrangThai: 'ACTIVE',
            UuDaiDacBiet: 'Test offer'
        };

        function addResult(step, status, message, details = '') {
            const resultDiv = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${status}`;
            resultItem.innerHTML = `
                <strong>${step}:</strong> ${message}
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultDiv.appendChild(resultItem);
        }

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<p>üîÑ Testing login...</p>';

            try {
                // First get the login form to get anti-forgery token
                const loginFormResponse = await fetch(`${baseUrl}/Auth/Login`);
                const loginFormHtml = await loginFormResponse.text();
                
                // Extract anti-forgery token
                const tokenMatch = loginFormHtml.match(/name="__RequestVerificationToken"[^>]*value="([^"]*)"/) ||
                                 loginFormHtml.match(/value="([^"]*)"[^>]*name="__RequestVerificationToken"/);
                
                if (!tokenMatch) {
                    throw new Error('Could not find anti-forgery token in login form');
                }
                
                authToken = tokenMatch[1];
                
                // Extract cookies from login form response
                const setCookieHeaders = loginFormResponse.headers.get('set-cookie');
                if (setCookieHeaders) {
                    sessionCookies = setCookieHeaders;
                }

                // Now submit login
                const formData = new FormData();
                formData.append('Username', 'admin');
                formData.append('Password', 'Admin@123');
                formData.append('__RequestVerificationToken', authToken);

                const loginResponse = await fetch(`${baseUrl}/Auth/Login`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: {
                        'Cookie': sessionCookies
                    }
                });

                if (loginResponse.ok) {
                    // Update session cookies
                    const newCookies = loginResponse.headers.get('set-cookie');
                    if (newCookies) {
                        sessionCookies = newCookies;
                    }
                    
                    resultDiv.innerHTML = '<p class="success">‚úÖ Login successful</p>';
                    addResult('Login', 'success', 'Admin login successful');
                } else {
                    throw new Error(`Login failed with status: ${loginResponse.status}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Login failed: ${error.message}</p>`;
                addResult('Login', 'error', 'Login failed', error.message);
            }
        }

        async function testGetCreateForm() {
            const resultDiv = document.getElementById('createFormResult');
            resultDiv.innerHTML = '<p>üîÑ Getting create form...</p>';

            try {
                const response = await fetch(`${baseUrl}/GoiTap/Create`, {
                    credentials: 'include',
                    headers: {
                        'Cookie': sessionCookies
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    
                    // Extract new anti-forgery token from create form
                    const tokenMatch = html.match(/name="__RequestVerificationToken"[^>]*value="([^"]*)"/) ||
                                     html.match(/value="([^"]*)"[^>]*name="__RequestVerificationToken"/);
                    
                    if (tokenMatch) {
                        authToken = tokenMatch[1];
                    }

                    resultDiv.innerHTML = '<p class="success">‚úÖ Create form loaded successfully</p>';
                    addResult('Get Create Form', 'success', 'Form loaded and anti-forgery token extracted');
                } else {
                    throw new Error(`Failed to get create form: ${response.status}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Failed to get create form: ${error.message}</p>`;
                addResult('Get Create Form', 'error', 'Failed to get create form', error.message);
            }
        }

        async function testSubmitCreateForm() {
            const resultDiv = document.getElementById('submitResult');
            resultDiv.innerHTML = '<p>üîÑ Submitting create form...</p>';

            try {
                const formData = new FormData();
                Object.keys(testData).forEach(key => {
                    formData.append(key, testData[key]);
                });
                formData.append('__RequestVerificationToken', authToken);

                const response = await fetch(`${baseUrl}/GoiTap/Create`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: {
                        'Cookie': sessionCookies
                    }
                });

                const responseText = await response.text();
                
                if (response.ok) {
                    if (response.redirected || responseText.includes('T·∫°o g√≥i t·∫≠p th√†nh c√¥ng')) {
                        resultDiv.innerHTML = '<p class="success">‚úÖ GoiTap created successfully</p>';
                        addResult('Submit Create Form', 'success', 'GoiTap created successfully');
                    } else {
                        resultDiv.innerHTML = '<p class="error">‚ùå Unexpected response</p>';
                        addResult('Submit Create Form', 'error', 'Unexpected response', responseText.substring(0, 500));
                    }
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Submit failed: ${response.status}</p>`;
                    addResult('Submit Create Form', 'error', `Submit failed: ${response.status}`, responseText.substring(0, 500));
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Submit error: ${error.message}</p>`;
                addResult('Submit Create Form', 'error', 'Submit error', error.message);
            }
        }

        async function testVerifyCreation() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.innerHTML = '<p>üîÑ Verifying creation...</p>';

            try {
                const response = await fetch(`${baseUrl}/GoiTap/Index`, {
                    credentials: 'include',
                    headers: {
                        'Cookie': sessionCookies
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    
                    if (html.includes(testData.TenGoi)) {
                        resultDiv.innerHTML = '<p class="success">‚úÖ GoiTap found in list</p>';
                        addResult('Verify Creation', 'success', 'GoiTap found in list');
                    } else {
                        resultDiv.innerHTML = '<p class="error">‚ùå GoiTap not found in list</p>';
                        addResult('Verify Creation', 'error', 'GoiTap not found in list');
                    }
                } else {
                    throw new Error(`Failed to get GoiTap list: ${response.status}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Verification error: ${error.message}</p>`;
                addResult('Verify Creation', 'error', 'Verification error', error.message);
            }
        }

        async function cleanup() {
            const resultDiv = document.getElementById('cleanupResult');
            resultDiv.innerHTML = '<p>üîÑ Cleaning up test data...</p>';
            
            // Note: This would require implementing a delete endpoint or manual cleanup
            resultDiv.innerHTML = '<p class="info">‚ÑπÔ∏è Manual cleanup required - check database for test data</p>';
            addResult('Cleanup', 'info', 'Manual cleanup required');
        }

        // Auto-run all tests
        async function runAllTests() {
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testGetCreateForm();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSubmitCreateForm();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testVerifyCreation();
        }

        // Add auto-run button
        document.addEventListener('DOMContentLoaded', function() {
            const autoRunBtn = document.createElement('button');
            autoRunBtn.textContent = 'üöÄ Run All Tests';
            autoRunBtn.className = 'btn-success';
            autoRunBtn.onclick = runAllTests;
            document.body.insertBefore(autoRunBtn, document.getElementById('results'));
        });
    </script>
</body>
</html>
